
name: Comprehensive Benchmarks

on:
  push:
    paths:
      - 'benchmarks/**'
      - 'src/**'
      - 'include/**'
      - 'CMakeLists.txt'
  pull_request:
    paths:
      - 'benchmarks/**'
      - 'src/**'
  workflow_dispatch:

jobs:
  benchmark:
    name: Benchmark on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
    - name: Checkout source
      uses: actions/checkout@v4

    # --- Language Setups ---
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.x'

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'
        cache: false

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'

    # --- Build Dependencies (LLVM) ---
    - name: Install LLVM (Ubuntu)
      if: matrix.os == 'ubuntu-latest'
      run: |
        sudo apt-get update
        sudo apt-get install -y llvm-dev libclang-dev clang build-essential

    - name: Install LLVM (macOS)
      if: matrix.os == 'macos-latest'
      run: |
        brew update
        brew install llvm
        echo "LLVM_DIR=$(brew --prefix llvm)/lib/cmake/llvm" >> $GITHUB_ENV
        echo "$(brew --prefix llvm)/bin" >> $GITHUB_PATH

    - name: Setup LLVM (Windows)
      if: matrix.os == 'windows-latest'
      shell: pwsh
      run: |
        choco install llvm --version 17.0.6 -y --force
        $llvmRoot = "C:\Program Files\LLVM"
        if (-not (Test-Path $llvmRoot)) { $llvmRoot = "C:\Program Files (x86)\LLVM" }
        Add-Content $env:GITHUB_PATH "$llvmRoot/bin"
        Add-Content $env:GITHUB_ENV "LLVM_ROOT=$llvmRoot"
        # Helper for CMake to find LLVM
        Add-Content $env:GITHUB_ENV "LLVM_DIR=$llvmRoot/lib/cmake/llvm"

    # --- Build ProXPL ---
    - name: Configure CMake
      shell: bash
      run: |
        cmake -S . -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_TESTS=OFF \
          -DBUILD_BENCH=OFF

    - name: Build ProXPL
      shell: bash
      run: cmake --build build --config Release

    # --- Run Benchmarks ---
    - name: Run Comparison Benchmarks
      shell: bash
      run: |
        if [ "${{ matrix.os }}" == "windows-latest" ]; then
          EXE_PATH="build/Release/proxpl.exe"
        else
          EXE_PATH="build/proxpl"
        fi
        
        echo "Running benchmarks with $EXE_PATH"
        # Run with buffered output explanation or simple run
        python benchmarks/run_benchmarks.py --executable "$EXE_PATH"
